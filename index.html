<!DOCTYPE html>
<html lang="pl" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PanDa to pytanie...</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'panda-red': '#ff6b35',    // Kolor Pandy Maej
                        'panda-green': '#10b981',  // Kolor Bambusa
                        'panda-dark': '#111827',   // Ciemne to
                        'panda-surface': '#1f2937' // Karty
                    },
                    animation: {
                        'bounce-slow': 'bounce 3s infinite',
                    }
                }
            }
        }
    </script>

    <!-- Vue.js 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- PeerJS -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <!-- Ikony FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { background-color: #111827; color: #f3f4f6; }
        .panda-gradient { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .red-panda-gradient { background: linear-gradient(135deg, #ff6b35 0%, #ea580c 100%); }
        
        /* Custom range slider for betting */
        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 24px;
            width: 24px;
            border-radius: 50%;
            background: #ff6b35;
            margin-top: -10px;
            cursor: pointer;
            border: 2px solid white;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            background: #4b5563;
            border-radius: 2px;
        }
    </style>
</head>
<body class="font-sans min-h-screen flex flex-col">

    <div id="app" class="flex-grow flex flex-col max-w-3xl mx-auto w-full p-4 relative">
        
        <!-- HEADER -->
        <header class="flex justify-between items-center mb-6 py-3 border-b border-gray-700 sticky top-0 bg-panda-dark/95 z-50 backdrop-blur-sm">
            <div class="flex items-center gap-2">
                <div class="text-3xl"></div>
                <div>
                    <h1 class="text-xl font-bold leading-tight text-white">PanDa <span class="text-panda-red">to pytanie...</span></h1>
                    <p class="text-[10px] text-gray-400 uppercase tracking-widest">Gra towarzyska</p>
                </div>
            </div>
            <div v-if="myPlayer" class="flex items-center gap-2 bg-gray-800 px-4 py-1.5 rounded-full border border-gray-600 shadow-lg">
                <span class="font-bold text-white">{{ myPlayer.name }}</span>
                <div class="w-px h-4 bg-gray-600"></div>
                <span class="text-yellow-400 font-bold flex items-center gap-1">
                    {{ myPlayer.score }} <span class="text-xs">PandaCoin</span>
                </span>
            </div>
        </header>

        <!-- CONNECTION STATUS / ERROR -->
        <div v-if="errorMessage" class="bg-red-900/80 text-white p-3 rounded-lg mb-4 text-center text-sm backdrop-blur-sm border border-red-500 animate-pulse">
            <i class="fa-solid fa-triangle-exclamation mr-2"></i> {{ errorMessage }}
            <button @click="errorMessage = ''" class="ml-4 underline text-xs">Zamknij</button>
        </div>

        <!-- VIEW: MENU -->
        <div v-if="view === 'menu'" class="flex flex-col items-center justify-center flex-grow gap-6 animate-fade-in">
            <div class="text-center space-y-2 mb-4">
                <div class="flex justify-center gap-4 text-6xl mb-4 animate-bounce-slow">
                    <span></span><span></span>
                </div>
                <h2 class="text-2xl font-bold text-white">Witaj w stadzie!</h2>
                <p class="text-gray-400 text-sm">Zbierz ekip, odpowiadaj szczerze i zgarniaj PandaCoiny.</p>
            </div>

            <div class="w-full max-w-xs space-y-4">
                <div>
                    <label class="block text-xs text-panda-green font-bold uppercase mb-1 ml-1">Tw贸j Nick</label>
                    <input v-model="nickname" type="text" maxlength="12" placeholder="Np. BambusowyZenek" 
                        class="w-full bg-gray-800 border-2 border-gray-600 rounded-xl p-3 text-white focus:border-panda-green focus:outline-none transition text-center font-bold placeholder-gray-600">
                </div>

                <div v-if="urlGameId" class="p-3 bg-panda-green/20 border border-panda-green rounded-xl text-center text-sm text-green-200">
                    Wykryto zaproszenie do gry!
                </div>

                <div class="grid gap-3 pt-2">
                    <button @click="createGame" :disabled="!nickname"
                        class="red-panda-gradient text-white font-bold py-3.5 rounded-xl shadow-lg shadow-orange-900/50 transition transform active:scale-95 disabled:opacity-50 disabled:grayscale">
                        <i class="fa-solid fa-crown mr-2"></i> Stw贸rz Gr (Host)
                    </button>
                    <button @click="joinGame" :disabled="!nickname"
                        class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3.5 rounded-xl border border-gray-500 transition transform active:scale-95 disabled:opacity-50 disabled:grayscale">
                        <i class="fa-solid fa-users mr-2"></i> Docz do Gry
                    </button>
                </div>
            </div>
        </div>

        <!-- VIEW: LOBBY -->
        <div v-if="view === 'lobby'" class="flex flex-col flex-grow">
            <div class="bg-panda-surface p-6 rounded-2xl border border-gray-700 text-center mb-6 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-panda-green to-panda-red"></div>
                <h2 class="text-2xl font-bold mb-1">Lobby</h2>
                <p class="text-gray-400 text-sm">Czekamy na reszt pand...</p>
                
                <div v-if="isHost" class="mt-6 bg-black/40 p-3 rounded-xl border border-dashed border-gray-600">
                    <p class="text-[10px] text-gray-400 uppercase mb-2 font-bold">Wylij link znajomym:</p>
                    <div class="flex items-center gap-2">
                        <input type="text" readonly :value="shareLink" class="w-full bg-transparent text-panda-green text-xs font-mono focus:outline-none text-ellipsis">
                        <button @click="copyLink" class="text-white hover:text-panda-green p-2 rounded-lg transition">
                            <i class="fa-regular fa-copy"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3 mb-auto">
                <div v-for="p in players" :key="p.id" class="bg-gray-800 p-4 rounded-xl flex flex-col items-center border border-gray-700 relative">
                    <i v-if="p.isHost" class="fa-solid fa-crown text-yellow-500 absolute top-2 right-2 text-xs"></i>
                    <div class="w-12 h-12 bg-gray-700 rounded-full flex items-center justify-center text-2xl mb-2 shadow-inner">
                        {{ getAvatar(p.name) }}
                    </div>
                    <span class="font-bold text-sm truncate w-full text-center">{{ p.name }}</span>
                </div>
            </div>

            <div v-if="isHost" class="mt-4 pb-4">
                <button @click="startGameLogic" :disabled="players.length < 2"
                    class="w-full panda-gradient text-white text-lg font-bold py-4 rounded-2xl shadow-xl shadow-green-900/40 transition transform hover:scale-[1.02] disabled:opacity-50 disabled:cursor-not-allowed">
                    GRAJMY! 
                </button>
                <p v-if="players.length < 2" class="text-center text-xs text-red-400 mt-3">Potrzeba min. 2 graczy.</p>
            </div>
            <div v-else class="mt-4 text-center pb-8 animate-pulse text-gray-400">
                <i class="fa-solid fa-spinner fa-spin mr-2"></i> Host odpala gr...
            </div>
        </div>

        <!-- VIEW: GAME -->
        <div v-if="view === 'game' && currentQuestion" class="flex flex-col flex-grow">
            
            <!-- Info Bar -->
            <div class="flex justify-between items-end mb-4 px-1">
                <div class="text-xs font-bold text-gray-500 uppercase">Runda {{ gameState.round }}/{{ maxRounds }}</div>
                <div class="text-right">
                    <div class="text-[10px] text-gray-500 uppercase">Aktywna Panda</div>
                    <div class="text-panda-red font-bold text-lg leading-none">{{ activePlayerName }}</div>
                </div>
            </div>

            <!-- Question Card -->
            <div class="bg-gray-800 p-6 rounded-3xl border-2 border-gray-700 shadow-2xl mb-6 relative">
                <div class="absolute -top-3 -left-2 text-4xl transform -rotate-12"></div>
                <h3 class="text-lg md:text-xl font-bold text-center leading-relaxed pt-2">{{ currentQuestion.q }}</h3>
            </div>

            <!-- PHASE 1: ANSWERING -->
            <div v-if="gameState.phase === 'answering'" class="flex-grow flex flex-col justify-center">
                <div v-if="amIActive" class="space-y-3">
                    <p class="text-center text-panda-red font-bold mb-2 text-sm uppercase tracking-wider">Wybierz szczerze!</p>
                    <button v-for="(ans, idx) in currentQuestion.a" :key="idx" @click="submitActiveChoice(idx)"
                        class="w-full p-4 bg-gray-800 hover:bg-gray-700 border-l-4 border-gray-600 hover:border-panda-red rounded-r-xl text-left transition-all group shadow-md">
                        <span class="font-bold text-panda-red mr-2 group-hover:text-white">{{ ['A','B','C','D'][idx] }}.</span>
                        <span class="text-gray-200 group-hover:text-white">{{ ans }}</span>
                    </button>
                </div>
                <div v-else class="text-center space-y-6 py-10">
                    <div class="relative inline-block">
                        <div class="w-20 h-20 bg-gray-800 rounded-full flex items-center justify-center text-4xl animate-bounce">
                            
                        </div>
                        <div class="absolute -bottom-1 -right-1 bg-gray-900 rounded-full p-1">
                            <i class="fa-solid fa-spinner fa-spin text-panda-red text-xl"></i>
                        </div>
                    </div>
                    <div>
                        <p class="text-lg font-bold text-white">{{ activePlayerName }}</p>
                        <p class="text-gray-400 text-sm">myli nad odpowiedzi...</p>
                    </div>
                </div>
            </div>

            <!-- PHASE 2: BETTING -->
            <div v-if="gameState.phase === 'betting'" class="flex-grow flex flex-col">
                <div v-if="!amIActive" class="flex flex-col h-full">
                    <div v-if="!hasBet" class="flex-grow flex flex-col">
                        <p class="text-center text-panda-green font-bold mb-4 text-sm uppercase">Jak odpowie {{ activePlayerName }}?</p>
                        
                        <div class="space-y-2 mb-6">
                            <button v-for="(ans, idx) in currentQuestion.a" :key="idx" 
                                @click="selectedBetAnswer = idx"
                                :class="selectedBetAnswer === idx ? 'border-panda-green bg-panda-green/10 ring-1 ring-panda-green' : 'border-gray-700 bg-gray-800'"
                                class="w-full p-3 border rounded-xl text-left transition flex items-center gap-3 text-sm">
                                <div class="w-6 h-6 rounded flex items-center justify-center text-xs font-bold"
                                     :class="selectedBetAnswer === idx ? 'bg-panda-green text-black' : 'bg-gray-700 text-gray-400'">
                                    {{ ['A','B','C','D'][idx] }}
                                </div>
                                <span :class="selectedBetAnswer === idx ? 'text-white' : 'text-gray-300'">{{ ans }}</span>
                            </button>
                        </div>

                        <div class="bg-gray-800 p-4 rounded-2xl border border-gray-700 mt-auto mb-4">
                            <div class="flex justify-between mb-4">
                                <span class="text-gray-400 text-xs uppercase font-bold mt-1">Stawka</span>
                                <span class="text-panda-red font-bold text-xl flex items-center gap-1">
                                    {{ betAmount }} <i class="fa-solid fa-coins text-xs"></i>
                                </span>
                            </div>
                            <input type="range" v-model.number="betAmount" min="1" max="3" step="1" class="w-full mb-2">
                            <div class="flex justify-between text-[10px] text-gray-500 uppercase font-bold">
                                <span>Niepewny</span>
                                <span>Pewniak</span>
                            </div>
                        </div>

                        <button @click="submitBet" :disabled="selectedBetAnswer === null"
                            class="w-full panda-gradient text-white font-bold py-4 rounded-xl shadow-lg shadow-green-900/30 transition transform active:scale-95 disabled:opacity-50 disabled:grayscale">
                            Obstawiam!
                        </button>
                    </div>
                    <div v-else class="flex flex-col items-center justify-center h-full text-center animate-fade-in">
                        <i class="fa-solid fa-circle-check text-5xl text-panda-green mb-4"></i>
                        <h3 class="text-xl font-bold text-white mb-2">Zakad przyjty!</h3>
                        <p class="text-gray-400 text-sm">Czekamy na reszt stada...</p>
                    </div>
                </div>
                <div v-else class="flex flex-col items-center justify-center h-full text-center space-y-6">
                    <div class="bg-gray-800 p-6 rounded-full border-4 border-gray-700">
                        <i class="fa-solid fa-user-secret text-4xl text-gray-400"></i>
                    </div>
                    <div>
                        <p class="text-lg text-white font-bold">Twoja odpowied藕 jest tajna.</p>
                        <p class="text-gray-400 text-sm mt-1">Reszta graczy pr贸buje zgadn...</p>
                    </div>
                    <div class="bg-gray-800 px-4 py-2 rounded border border-gray-700 text-sm text-panda-red">
                        Wybrae: <strong>{{ ['A','B','C','D'][gameState.activeChoice] }}</strong>
                    </div>
                </div>
            </div>

            <!-- PHASE 3: RESULTS -->
            <div v-if="gameState.phase === 'result'" class="flex-grow flex flex-col animate-fade-in pb-4">
                <div class="text-center mb-6">
                    <p class="text-gray-500 text-[10px] uppercase font-bold mb-2">{{ activePlayerName }} wybra:</p>
                    <div class="bg-gradient-to-r from-gray-800 to-gray-700 p-4 rounded-xl border-l-4 border-panda-green shadow-lg text-left flex items-center gap-3">
                        <div class="bg-panda-green text-black font-bold w-8 h-8 rounded flex items-center justify-center flex-shrink-0">
                            {{ ['A','B','C','D'][gameState.activeChoice] }}
                        </div>
                        <span class="font-bold text-white text-sm md:text-base">{{ currentQuestion.a[gameState.activeChoice] }}</span>
                    </div>
                </div>

                <div class="space-y-2 mb-6 overflow-y-auto max-h-64 pr-1">
                    <div v-for="res in roundResults" :key="res.id" 
                        class="flex items-center justify-between p-3 rounded-lg bg-gray-800 border border-gray-700"
                        :class="{'border-green-500/40 bg-green-900/10': res.won && !res.isActive, 'opacity-75': !res.won && !res.isActive, 'border-blue-500/40 bg-blue-900/10': res.isActive}">
                        
                        <div class="flex items-center gap-2">
                            <span class="text-lg">{{ getAvatar(res.name) }}</span>
                            <div class="flex flex-col">
                                <span class="font-bold text-sm leading-none">{{ res.name }}</span>
                                <span v-if="!res.isActive" class="text-[10px] text-gray-400 mt-1">
                                    Typ: <strong :class="res.won ? 'text-panda-green' : 'text-red-400'">{{ ['A','B','C','D'][res.betAnswer] }}</strong> ({{res.wager}} )
                                </span>
                                <span v-else class="text-[10px] text-blue-300 mt-1">Aktywny gracz</span>
                            </div>
                        </div>

                        <div class="font-bold text-base" 
                             :class="res.change > 0 ? 'text-panda-green' : (res.change < 0 ? 'text-red-400' : 'text-gray-400')">
                            {{ res.change > 0 ? '+' : ''}}{{ res.change }}
                        </div>
                    </div>
                </div>

                <div v-if="isHost" class="mt-auto pt-2">
                    <button @click="nextRound" class="w-full bg-white text-black hover:bg-gray-200 py-4 rounded-xl font-bold text-lg shadow-lg transition">
                        Dalej <i class="fa-solid fa-arrow-right ml-2"></i>
                    </button>
                </div>
                <div v-else class="mt-auto text-center text-gray-500 text-xs animate-pulse uppercase font-bold">
                    Host klika dalej...
                </div>
            </div>

        </div>

        <!-- VIEW: GAMEOVER -->
        <div v-if="view === 'gameover'" class="flex flex-col items-center justify-center flex-grow text-center animate-fade-in">
            <div class="text-6xl mb-2"></div>
            <h2 class="text-3xl font-bold text-white mb-1">Koniec Gry!</h2>
            <p class="text-gray-400 text-sm mb-8">Kto jest najwikszym ekspertem od ludzi?</p>
            
            <div class="w-full bg-gray-800 rounded-2xl border border-gray-700 overflow-hidden mb-6">
                <div v-for="(p, idx) in sortedPlayers" :key="p.id" 
                    class="flex items-center justify-between p-4 border-b border-gray-700 last:border-0 relative"
                    :class="idx === 0 ? 'bg-yellow-500/10' : ''">
                    <div class="flex items-center gap-3 relative z-10">
                        <div class="font-mono font-bold text-gray-500 w-6 text-left" :class="{'text-yellow-400 text-xl': idx===0}">{{ idx + 1 }}.</div>
                        <div class="text-2xl">{{ getAvatar(p.name) }}</div>
                        <span class="font-bold" :class="{'text-yellow-400': idx===0}">{{ p.name }}</span>
                    </div>
                    <div class="font-bold text-panda-green relative z-10">
                        {{ p.score }} <span class="text-xs text-gray-500">PC</span>
                    </div>
                    <!-- Crown for winner -->
                    <i v-if="idx===0" class="fa-solid fa-crown text-yellow-500/20 text-6xl absolute right-10 top-1/2 transform -translate-y-1/2 rotate-12"></i>
                </div>
            </div>

            <button @click="restartGame" v-if="isHost" class="text-gray-400 hover:text-white underline text-sm">
                Zagraj jeszcze raz (zresetuj punkty)
            </button>
        </div>

    </div>

    <!-- LOGIC -->
    <script>
        const RAW_QUESTIONS = [
          { "q": "Co jest dla mnie najwa偶niejsze na pierwszej randce?", "a": ["Dobra rozmowa", "Wyczuwalna chemia", "Dobre maniery", "Atrakcyjny wygld"] },
          { "q": "Jak najczciej okazuj, 偶e kto mi si podoba?", "a": ["Utrzymuj kontakt wzrokowy", "Du偶o 偶artuj i si miej", "Zadaj mn贸stwo pyta", "Czekam, a偶 ta osoba zrobi krok"] },
          { "q": "Jaki gest romantyczny najbardziej mnie roztkliwia?", "a": ["Kwiaty bez okazji", "Wasnorcznie napisany list", "niadanie do 贸偶ka", "Niespodziewany wyjazd"] },
          { "q": "Kto powinien zapaci za kolacj na randce?", "a": ["M偶czyzna", "Dzielimy si po poowie", "Ten, kto zaprasza", "Ka偶dy paci za siebie"] },
          { "q": "Co myl o publicznym okazywaniu uczu (trzymanie za rk, przytulanie)?", "a": ["Uwielbiam, to urocze", "Tylko dyskretnie", "Nie lubi tego", "Zale偶y od towarzystwa"] },
          { "q": "Jaka cecha charakteru u partnera/partnerki najbardziej mi imponuje?", "a": ["Inteligencja", "Opiekuczo", "Zaradno 偶yciowa", "Poczucie humoru"] },
          { "q": "M贸j idealny pomys na spdzenie rocznicy to:", "a": ["Romantyczna kolacja w domu", "Wyjcie do opery/teatru", "Wyjazd za miasto", "Wsp贸lna aktywno sportowa"] },
          { "q": "Czy wierz w mio od pierwszego wejrzenia?", "a": ["Tak, absolutnie", "Wierz w zauroczenie", "Nie, mio wymaga czasu", "To tylko wymys filmowc贸w"] },
          { "q": "Jak reaguj na komplementy?", "a": ["Rumieni si", "Obracam w 偶art", "Dzikuj z umiechem", "Zaprzeczam skromnie"] },
          { "q": "Co najbardziej ceni w dugotrwaym zwizku?", "a": ["Zaufanie", "Namitno", "Przyja藕", "Wsp贸lne cele"] },
          { "q": "Jakie jest moje podejcie do zazdroci?", "a": ["Jestem bardzo zazdrosny/a", "Odrobina dodaje pikanterii", "Ufam w 100%", "Ukrywam zazdro"] },
          { "q": "Gdybym mia/a wybra film do obejrzenia przytulonym na kanapie, byby to:", "a": ["Komedia romantyczna", "Stary klasyk kinowy", "Film przygodowy", "Dramat kostiumowy"] },
          { "q": "Co jest dla mnie 'deal-breakerem' (skrela osob) na pocztku znajomoci?", "a": ["Brak kultury osobistej", "Palenie papieros贸w", "Cige m贸wienie o sobie", "Brak ambicji"] },
          { "q": "Jak wa偶ny jest dla mnie wygld partnera?", "a": ["Najwa偶niejszy", "Wa偶ny, ale nie kluczowy", "Liczy si tylko wntrze", "Musi by zadbany/a"] },
          { "q": "Czy lubi niespodzianki?", "a": ["Kocham!", "Tylko te przemylane", "Wol mie kontrol", "Stresuj mnie"] },
          { "q": "Jaki styl ubierania u pci przeciwnej najbardziej mi si podoba?", "a": ["Elegancki/Klasyczny", "Sportowy/Luzacki", "Artystyczny/Oryginalny", "Casual/Codzienny"] },
          { "q": "Jakie jest moje zdanie na temat lubu?", "a": ["Marz o wielkim weselu", "Kameralna uroczysto", "Tylko cywilny", "Papier nie jest potrzebny"] },
          { "q": "Gdy mam gorszy dzie, czego potrzebuj od drugiej po贸wki?", "a": ["Wysuchania", "Przytulenia", "Rozmieszenia", "Zostawienia w spokoju"] },
          { "q": "Czy potrafi przyzna si do bdu w relacji?", "a": ["Tak, od razu", "Po du偶szym czasie", "Przychodzi mi to z trudem", "Rzadko si myl"] },
          { "q": "Co myl o przyja藕ni damsko-mskiej?", "a": ["Istnieje i jest super", "Mo偶liwa, ale rzadka", "Nie wierz w ni", "Tylko jeli to dawni znajomi"] },
          { "q": "M贸j stosunek do taca to:", "a": ["Uwielbiam i umiem", "Lubi, ale nie umiem", "Tylko po drinku", "Unikam parkietu"] },
          { "q": "Gdybym m贸g/moga wyjecha gdziekolwiek teraz, wybrabym/abym:", "a": ["Pary偶", "Domek w Bieszczadach", "Nowy Jork", "Tropikaln wysp"] },
          { "q": "Jak rol w moim 偶yciu odgrywa rodzina?", "a": ["Jest najwa偶niejsza", "Wa偶na, ale z dystansem", "Spotykamy si tylko w wita", "Wol przyjaci贸"] },
          { "q": "Czy lubi gotowa dla kogo?", "a": ["Tak, to moja mio", "Tylko proste dania", "Wol, jak kto gotuje dla mnie", "Traktuj to jako obowizek"] },
          { "q": "Co robi w woln sobot rano?", "a": ["pi do poudnia", "Id biega/na spacer", "Sprztam mieszkanie", "Jem powolne niadanie"] },
          { "q": "Jak podchodz do porzdku w domu?", "a": ["Jestem pedantem", "Lubi porzdek, bez przesady", "Artystyczny niead", "Sprztam, gdy musz"] },
          { "q": "Gdybym wygra/a w Lotto, co zrobibym/abym z prac?", "a": ["Rzucam natychmiast", "Przechodz na p贸 etatu", "Pracuj dalej, bo lubi", "Zakadam wasn firm"] },
          { "q": "Jaki jest m贸j typ osobowoci?", "a": ["Dusza towarzystwa", "Spokojny obserwator", "Wieczny optymista", "Realista stpajcy po ziemi"] },
          { "q": "Co sdz o posiadaniu zwierzt?", "a": ["Dom bez psa/kota to nie dom", "Lubi, ale u kogo", "Tylko rybki", "Wol sterylny porzdek"] },
          { "q": "Jakim kierowc jestem?", "a": ["Szybkim i wciekym", "Ostro偶nym i przepisowym", "Niedzielnym", "Wol by pasa偶erem"] },
          { "q": "Moja ulubiona pora roku to:", "a": ["Wiosna (wszystko kwitnie)", "Lato (ciepo i wakacje)", "Jesie (klimat i kolory)", "Zima (wita i nieg)"] },
          { "q": "Czy jestem osob punktualn?", "a": ["Zawsze przed czasem", "Punktualnie co do minuty", "Zdarzaj mi si polizgi", "Notorycznie si sp贸藕niam"] },
          { "q": "Jak radz sobie ze stresem?", "a": ["Aktywno fizyczna", "Rozmowa z bliskimi", "Zajadam sodycze", "Sucham muzyki/czytam"] },
          { "q": "Co jest dla mnie wyznacznikiem sukcesu?", "a": ["Szczliwa rodzina", "Kariera i pienidze", "Wewntrzny spok贸j", "Podr贸偶e i przygody"] },
          { "q": "Jaki rodzaj kuchni lubi najbardziej?", "a": ["Tradycyjn polsk", "Wosk (pasta/pizza)", "Azjatyck/Ostr", "Lekkie saatki"] },
          { "q": "Czy lubi czyta ksi偶ki?", "a": ["Poykam tomy", "Czasem, na wakacjach", "Wol audiobooki", "Wol filmy"] },
          { "q": "Moje podejcie do nowych technologii:", "a": ["Musz mie najnowsze gad偶ety", "U偶ywam tego, co konieczne", "Tskni za czasami offline", "Mam do nich dystans"] },
          { "q": "Czy jestem osob oszczdn?", "a": ["Tak, planuj bud偶et", "Staram si, ale nie wychodzi", "呕yje si raz", "Inwestuj ka偶d nadwy偶k"] },
          { "q": "Jakie wita lubi najbardziej?", "a": ["Bo偶e Narodzenie", "Wielkanoc", "Swoje urodziny", "Sylwestra"] },
          { "q": "Czy atwo nawizuj nowe znajomoci?", "a": ["Tak, zagadam do ka偶dego", "Potrzebuj chwili na rozkrcenie", "Czekam, a偶 kto zagada", "Wol sprawdzone grono"] },
          { "q": "Co najbardziej mnie denerwuje w ludziach?", "a": ["Hipokryzja", "Gupota", "Brak higieny", "Arogancja"] },
          { "q": "Czy wierz w przeznaczenie?", "a": ["Tak, wszystko jest zapisane", "Wierz w przypadki", "Kujemy wasny los", "Troch tak, troch nie"] },
          { "q": "Jaki jest m贸j stosunek do tradycji?", "a": ["Bardzo j szanuj", "Lubi wybrane elementy", "Tworz wasne tradycje", "To prze偶ytek"] },
          { "q": "Gdybym m贸g/moga mie jeden talent, byoby to:", "a": ["piewanie", "Malowanie", "Jzyki obce", "Gra na instrumencie"] },
          { "q": "Co robi, gdy znajd pajka w domu?", "a": ["Zabijam kapciem", "Wynosz na zewntrz", "Krzycz i wzywam pomocy", "Ignoruj go"] },
          { "q": "Czy jestem sow czy skowronkiem?", "a": ["Wstaj o wicie z energi", "Najlepiej funkcjonuj w nocy", "Lubi spa do poudnia", "Dostosowuj si do sytuacji"] },
          { "q": "Jaki prezent wolabym/abym dosta?", "a": ["Praktyczny (np. sprzt)", "Sentymentalny (np. album)", "Luksusowy (np. zegarek)", "Zabawny gad偶et"] },
          { "q": "Co myl o mediach spoecznociowych?", "a": ["Marnuj czas", "S wietne do kontaktu", "U偶ywam tylko do pracy", "Lubi podglda innych"] },
          { "q": "Czy potrafi dochowa tajemnicy?", "a": ["Gr贸b to przy mnie gadua", "Zazwyczaj tak", "M贸wi tylko jednej osobie", "Jest to dla mnie trudne"] },
          { "q": "Jaki jest m贸j wymarzony dom?", "a": ["Dworek na wsi", "Apartament w centrum", "Nowoczesna willa", "May domek z ogr贸dkiem"] },
          { "q": "Co sdz o tatua偶ach?", "a": ["Podobaj mi si", "Mam lub chc mie", "Nie w moim stylu", "Cakowicie nie akceptuj"] },
          { "q": "Czy lubi gry planszowe?", "a": ["Uwielbiam rywalizacj", "Gram dla towarzystwa", "Nudz mnie", "Wol karty"] },
          { "q": "Jak reaguj na pacz innej osoby?", "a": ["Czuj si niezrcznie", "Od razu pocieszam", "Sam/a zaczynam paka", "Analizuj przyczyn"] },
          { "q": "Czy jestem osob pamitliw?", "a": ["Pamitam ka偶d krzywd", "Wybaczam, ale pamitam", "Szybko zapominam", "Nie chowam urazy"] },
          { "q": "Jaki sport najchtniej uprawiam/ogldam?", "a": ["Pika no偶na", "Tenis/Squash", "Bieganie/Siownia", "Szachy/E-sport"] },
          { "q": "Czy lubi chodzi do muze贸w?", "a": ["Tak, to fascynujce", "Tylko za granic", "Szybko si nudz", "Wol galeri handlow"] },
          { "q": "Co jest moim guilty pleasure (grzeszn przyjemnoci)?", "a": ["Sodycze noc", "Tanie reality show", "Zakupy online", "Plotkowanie"] },
          { "q": "Czy ufam swojej intuicji?", "a": ["Zawsze mnie prowadzi", "Czasami sucham", "Wol logik", "Czsto mnie myli"] },
          { "q": "Jakie jest moje podejcie do zdrowego od偶ywiania?", "a": ["Restrykcyjna dieta", "Staram si je zdrowo", "Jem to, na co mam ochot", "Zaczynam od poniedziaku"] },
          { "q": "Czy lubi majsterkowa/naprawia rzeczy?", "a": ["Zota rczka", "Potrafi proste rzeczy", "Od razu dzwoni po fachowca", "Psuj jeszcze bardziej"] },
          { "q": "Gdybym m贸g/moga zje kolacj ze znan osob, byby to:", "a": ["Papie偶/Duchowny", "Ulubiony aktor/aktorka", "Wielki naukowiec", "Gwiazda muzyki"] },
          { "q": "Jaka muzyka najlepiej mnie opisuje?", "a": ["Rock/Klasyka rocka", "Pop i hity radiowe", "Muzyka klasyczna/Jazz", "Disco/Dance"] },
          { "q": "Czy jestem osob sentymentaln?", "a": ["Zbieram bilety i pamitki", "Lubi powspomina", "呕yj tylko przyszoci", "Wyrzucam stare rzeczy"] },
          { "q": "Co robi, gdy kelner pomyli zam贸wienie?", "a": ["Grzecznie prosz o wymian", "Zjadam, nie chc robi kopotu", "Denerwuj si", "呕artuj z sytuacji"] },
          { "q": "Jaki jest m贸j stosunek do polityki?", "a": ["ledz i dyskutuj", "Mam pogldy, ale nie m贸wi", "Nie interesuje mnie to", "To tylko k贸tnie"] },
          { "q": "Czy boj si staroci?", "a": ["Tak, przera偶a mnie", "Akceptuj kolej rzeczy", "Byle by zdrowym", "Czekam na mdro wieku"] },
          { "q": "Gdybym m贸g/moga cofn czas, co bym zmieni/a?", "a": ["Kierunek studi贸w/Prac", "Jedn relacj", "Inwestycje finansowe", "Nic, wszystko ma cel"] },
          { "q": "Czy lubi wystpowa publicznie?", "a": ["Czuj si jak ryba w wodzie", "Stresuj si, ale daj rad", "Unikam jak ognia", "Tylko w maym gronie"] },
          { "q": "Co sdz o horoskopach?", "a": ["Sprawdzam codziennie", "Czytam dla zabawy", "To bzdury", "Czasem co si sprawdza"] },
          { "q": "Jaki jest m贸j idealny urlop?", "a": ["Le偶enie plackiem na pla偶y", "Intensywne zwiedzanie", "Trekking w g贸rach", "Zaszycie si w guszy"] },
          { "q": "Czy potrafi mia si z siebie?", "a": ["Tak, mam du偶y dystans", "Zale偶y z czego", "Raczej bior wszystko serio", "Nie lubi by obiektem 偶art贸w"] },
          { "q": "Czy jestem osob religijn/duchow?", "a": ["Tak, to dla mnie wa偶ne", "Tradycyjnie", "Mam wasn filozofi", "Jestem sceptykiem"] },
          { "q": "Czego nie lubi w jedzeniu?", "a": ["Owoc贸w morza", "Podrob贸w", "Zbyt ostrych rzeczy", "Jestem wszystko偶erny/a"] },
          { "q": "Jaki kolor dominuje w mojej szafie?", "a": ["Czarny/Szary", "Kolorowy/Wzorzysty", "Biel/Be偶", "Niebieski/Granatowy"] },
          { "q": "Czy lubi du偶e imprezy i wesela?", "a": ["Bawi si do biaego rana", "Lubi, ale kr贸tko", "Wol kameralne spotkania", "Chodz z obowizku"] },
          { "q": "Co robi, gdy widz kogo potrzebujcego na ulicy?", "a": ["Daj pienidze", "Kupuj jedzenie", "Modl si/Myl ciepo", "Omijam wzrokiem"] },
          { "q": "Czy jestem uparty/a?", "a": ["Jak osio", "Tylko w wa偶nych sprawach", "atwo ulegam argumentom", "Szukam kompromisu"] },
          { "q": "Co sdz o paleniu papieros贸w?", "a": ["Pal i lubi", "Pal okazjonalnie", "Nie przeszkadza mi u innych", "Nie toleruj dymu"] },
          { "q": "Czy atwo wydaj pienidze na przyjemnoci?", "a": ["Tak, nale偶y mi si", "Mam wyrzuty sumienia", "Rzadko to robi", "Tylko na promocjach"] },
          { "q": "Jakim byem uczniem w szkole?", "a": ["Wzorowym kujonem", "Przecitnym, ale sprytnym", "Rozrabiak", "Artystyczn dusz"] },
          { "q": "Czy lubi biwakowanie pod namiotem?", "a": ["Kocham natur", "Jedn noc wytrzymam", "Wol hotel z azienk", "Nigdy w 偶yciu"] },
          { "q": "Czy jestem gadu?", "a": ["Usta mi si nie zamykaj", "Zale偶y od tematu", "Wol sucha", "Jestem maom贸wny/a"] },
          { "q": "Co jest dla mnie najwa偶niejsze w pracy?", "a": ["Pienidze", "Atmosfera", "Pasja/Rozw贸j", "Stabilizacja"] },
          { "q": "Czy obgaduj znajomych?", "a": ["Zdarza si ka偶demu", "Nigdy, to nieeleganckie", "Tylko nieszkodliwie", "Wymieniam informacje"] },
          { "q": "Jaka jest moja najwiksza wada?", "a": ["Lenistwo", "Niemiao", "Baaganiarstwo", "Impulsywno"] },
          { "q": "Czy lubi spdza czas sam/a ze sob?", "a": ["Tak, aduj baterie", "Chwil tak, ale kr贸tko", "Nie, musz mie ludzi", "Zawsze co sobie znajd"] },
          { "q": "Gdybym m贸g/moga mieszka w innej epoce, byoby to:", "a": ["Lata 20. XX wieku", "redniowiecze", "Wiktoriaska Anglia", "Staro偶ytno"] },
          { "q": "Czy mam 'rk do kwiat贸w'?", "a": ["Robi d偶ungl w domu", "Kaktusy prze偶yj", "Wszystko usycha", "Wol sztuczne"] },
          { "q": "Jaki jest m贸j stosunek do ryzyka?", "a": ["Lubi adrenalin", "Kalkuluj zyski i straty", "Jestem asekurantem", "Unikam jak ognia"] },
          { "q": "Czy jestem typem lidera?", "a": ["Naturalnie przejmuj dowodzenie", "Wol wsp贸pracowa", "Wol wykonywa polecenia", "Jestem samotnym wilkiem"] },
          { "q": "Co sdz o zapuszczaniu brody (u m偶czyzn)?", "a": ["Bardzo mskie", "Lekki zarost jest ok", "Wol gadk twarz", "Obojtne mi to"] },
          { "q": "Czy czsto korzystam z telefonu w towarzystwie?", "a": ["Tak, to nawyk", "Staram si nie", "Nigdy, to brak szacunku", "Tylko jak czekam na wa偶n info"] },
          { "q": "Czy lubi kaw?", "a": ["Nie 偶yj bez niej", "Pij dla smaku", "Wol herbat", "Tylko z du偶 iloci mleka"] },
          { "q": "Co myl o operacjach plastycznych?", "a": ["Wszystko jest dla ludzi", "Drobne poprawki s ok", "Nale偶y starze si z godnoci", "To pr贸偶no"] },
          { "q": "Czy lubi chodzi na zakupy odzie偶owe?", "a": ["To m贸j relaks", "Id, gdy musz", "Wol online", "Nienawidz przymierzalni"] },
          { "q": "Jakie jest moje wymarzone auto?", "a": ["Szybkie sportowe", "Wielki SUV", "Klasyczny zabytkowy", "Mae i miejskie"] },
          { "q": "Czy jestem osob cierpliw?", "a": ["Mam anielsk cierpliwo", "Zazwyczaj tak", "Szybko wybucham", "Nie znosz czekania"] },
          { "q": "Co najbardziej uspokaja mnie po ci偶kim dniu?", "a": ["Gorca kpiel", "Dobre jedzenie", "Sen", "Spacer"] },
          { "q": "Czy zwracam uwag na marki produkt贸w?", "a": ["Tak, jako kosztuje", "Tylko w elektronice/autach", "Nie, paci si za logo", "Szukam okazji"] },
          { "q": "Czy jestem szczliwym czowiekiem?", "a": ["Bardzo szczliwym", "Brakuje mi kilku rzeczy", "Pracuj nad tym", "Mam trudny okres"] },
          { "q": "Kiedy jest odpowiedni czas na pierwszy pocaunek?", "a": ["Ju偶 na pierwszej randce", "Na drugiej lub trzeciej", "Dopiero po du偶szym poznaniu", "Czekam na inicjatyw drugiej strony"] },
          { "q": "Co dziaa na mnie najbardziej przycigajco?", "a": ["Gbokie spojrzenie w oczy", "Przypadkowy dotyk doni", "Przyjemny gos/Szept", "Zapach perfum"] },
          { "q": "W czym najchtniej pi?", "a": ["W klasycznej pi偶amie", "W lu藕nym T-shircie", "W bieli藕nie", "W stroju Ewy/Adama"] },
          { "q": "Jaki rodzaj czuoci lubi najbardziej?", "a": ["Trzymanie za rk", "Gadzenie po plecach/wosach", "Przytulanie na 'misia'", "Pocaunki w szyj"] },
          { "q": "Co sdz o niadaniu podanym do 贸偶ka?", "a": ["Szczyt romantyzmu", "Mie, ale wol przy stole", "Niewygodne (okruchy!)", "Wystarczy mi kawa"] },
          { "q": "Jakie wiato buduje najlepszy nastr贸j wieczorem?", "a": ["Blask wiec", "Przygaszona lampka nocna", "Cakowita ciemno", "Blask kominka/TV"] },
          { "q": "Czy kobieta powinna przejmowa inicjatyw we flircie?", "a": ["Tak, to bardzo pocigajce", "Nie, to rola m偶czyzny", "Tylko subtelnie dajc znaki", "Zale偶y od sytuacji"] },
          { "q": "Jaki zapach u partnera/partnerki lubi najbardziej?", "a": ["wie偶y/Cytrusowy", "Ci偶ki/Pi偶mowy/Drzewny", "Sodki/Kwiatowy", "Naturalny zapach sk贸ry"] },
          { "q": "Co myl o masa偶u wykonanym przez partnera?", "a": ["Uwielbiam i si rozpywam", "Wol sam/a masowa", "Krpuje mnie to", "Tylko bolcych plec贸w"] },
          { "q": "Jak reaguj na szept do ucha?", "a": ["Przechodz mnie ciarki", "To mnie askocze/mieszy", "Uwa偶am to za bardzo intymne", "Nie sysz, prosz goniej"] },
          { "q": "Taniec przytualniec (wolny) to dla mnie:", "a": ["wietna okazja do bliskoci", "Tylko na weselach", "Stresujca sytuacja", "Romantyczny moment"] },
          { "q": "W jakim stroju partner/ka podoba mi si najbardziej?", "a": ["W eleganckim/wieczorowym", "W czym opinajcym ciao", "W domowym dresie", "W mojej koszuli/bluzie"] },
          { "q": "Pocaunek w miejscu publicznym (np. w parku) jest:", "a": ["Niedopuszczalny, to niekulturalne", "Dopuszczalny, ale dyskretny", "Lubi pokaza, 偶e jestemy razem", "Nie zwracam uwagi na innych"] },
          { "q": "Co jest najbardziej zmysow czci ciaa (poza oczywistymi)?", "a": ["Donie", "Szyja/Kark", "Plecy", "Usta"] },
          { "q": "Jakie filmy ogldane we dwoje buduj najlepsze napicie?", "a": ["Romanse z happy endem", "Horrory (偶eby si przytuli)", "Filmy z nutk erotyzmu", "Komedie, 偶eby si rozlu藕ni"] },
          { "q": "Dugie patrzenie sobie gboko w oczy...", "a": ["Prowokuje mnie do miechu", "Oniemiela mnie", "To najlepsza gra wstpna", "Pozwala zajrze w dusz"] },
          { "q": "Idealne zakoczenie udanej randki to:", "a": ["Namitny pocaunek", "D偶entelmeskie odprowadzenie pod drzwi", "Zaproszenie na 'kaw'", "Duga rozmowa w samochodzie"] },
          { "q": "Czy wygld ma znaczenie w sypialni (np. bielizna, pociel)?", "a": ["Tak, jestem wzrokowcem", "Licz si tylko uczucia", "Lubi, gdy jest elegancko", "Wa偶niejszy jest zapach i dotyk"] },
          { "q": "Kiedy m贸wi 'kocham' po raz pierwszy?", "a": ["Gdy tylko to poczuj", "Czekam, a偶 druga osoba to powie", "Po dugim czasie, by mie pewno", "Kiedy emocje bior g贸r"] },
          { "q": "Co sdz o karmieniu si nawzajem (np. truskawk)?", "a": ["Bardzo zmysowe", "Zabawne i urocze", "Troch dziecinne", "Nie lubi tego"] }
        ];

        const { createApp, ref, reactive, computed, onMounted, watch } = Vue;

        createApp({
            setup() {
                // --- STATE ---
                const view = ref('menu'); 
                const nickname = ref('');
                const urlGameId = ref('');
                const errorMessage = ref('');
                const shareLink = ref('');
                
                const peer = ref(null);
                const conn = ref(null);
                const connections = ref([]);
                const isHost = ref(false);
                const myId = ref('');
                
                // Shared Game State
                const gameState = reactive({
                    players: [], // { id, name, score, isHost }
                    round: 0,
                    phase: 'lobby', 
                    activePlayerId: null,
                    questionIndex: 0,
                    activeChoice: null, 
                    bets: {},
                    usedQuestions: [] // To avoid repetition
                });

                const selectedBetAnswer = ref(null);
                const betAmount = ref(1);
                const hasBet = ref(false);
                const maxRounds = 15; 

                // --- COMPUTED ---
                const myPlayer = computed(() => gameState.players.find(p => p.id === myId.value));
                const activePlayer = computed(() => gameState.players.find(p => p.id === gameState.activePlayerId));
                const activePlayerName = computed(() => activePlayer.value ? activePlayer.value.name : 'Panda');
                const amIActive = computed(() => gameState.activePlayerId === myId.value);
                const currentQuestion = computed(() => RAW_QUESTIONS[gameState.questionIndex]);
                const players = computed(() => gameState.players);
                
                const roundResults = computed(() => {
                    if (gameState.phase !== 'result') return [];
                    return gameState.players.map(p => {
                        const isAct = p.id === gameState.activePlayerId;
                        const bet = gameState.bets[p.id];
                        let change = 0;
                        let won = false;

                        if (isAct) {
                            const correctGuesses = Object.values(gameState.bets).filter(b => b.answer === gameState.activeChoice).length;
                            change = correctGuesses * 2; 
                        } else if (bet) {
                            if (bet.answer === gameState.activeChoice) {
                                change = bet.wager * 2; 
                                won = true;
                            } else {
                                change = -bet.wager;
                                won = false;
                            }
                        }
                        return { 
                            id: p.id, 
                            name: p.name, 
                            isActive: isAct, 
                            change: change, 
                            won: won, 
                            wager: bet ? bet.wager : 0,
                            betAnswer: bet ? bet.answer : null
                        };
                    });
                });

                const sortedPlayers = computed(() => {
                    return [...gameState.players].sort((a, b) => b.score - a.score);
                });

                // --- HELPER: AVATAR ---
                const getAvatar = (name) => {
                    const avatars = ['', '', '', '', '', '', '', ''];
                    if(!name) return '';
                    let hash = 0;
                    for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
                    return avatars[Math.abs(hash) % avatars.length];
                }

                // --- LIFECYCLE ---
                onMounted(() => {
                    const params = new URLSearchParams(window.location.search);
                    if (params.get('gameId')) urlGameId.value = params.get('gameId');
                });

                // --- PEERJS ---
                const initPeer = () => {
                    return new Promise((resolve) => {
                        const p = new Peer(null, { debug: 1 });
                        p.on('open', (id) => {
                            myId.value = id;
                            resolve(id);
                        });
                        p.on('error', (err) => {
                            errorMessage.value = "Bd sieci: " + err.type;
                        });
                        peer.value = p;
                    });
                };

                const createGame = async () => {
                    isHost.value = true;
                    await initPeer();
                    gameState.players.push({ id: myId.value, name: nickname.value, score: 20, isHost: true });
                    shareLink.value = `${window.location.origin}${window.location.pathname}?gameId=${myId.value}`;
                    
                    peer.value.on('connection', (c) => {
                        connections.value.push(c);
                        c.on('data', (data) => handleDataFromClient(c, data));
                        c.on('open', () => c.send({ type: 'STATE_UPDATE', payload: gameState })); // Send state immediately
                    });
                    view.value = 'lobby';
                };

                const joinGame = async () => {
                    isHost.value = false;
                    const hostId = urlGameId.value || prompt("Podaj ID gry:");
                    if (!hostId) return;
                    await initPeer();
                    conn.value = peer.value.connect(hostId);
                    conn.value.on('open', () => {
                        conn.value.send({ type: 'JOIN', payload: { name: nickname.value } });
                    });
                    conn.value.on('data', (data) => {
                        if (data.type === 'STATE_UPDATE') {
                            Object.assign(gameState, data.payload);
                            if (gameState.phase === 'lobby') view.value = 'lobby';
                            else if (gameState.phase === 'gameover') view.value = 'gameover';
                            else view.value = 'game';
                        }
                    });
                    conn.value.on('close', () => errorMessage.value = "Rozczono z hostem.");
                };

                // --- HOST LOGIC ---
                const broadcastState = () => {
                    const data = { type: 'STATE_UPDATE', payload: gameState };
                    connections.value.forEach(c => c.send(data));
                };

                const handleDataFromClient = (conn, data) => {
                    if (!isHost.value) return;
                    if (data.type === 'JOIN') {
                        if (!gameState.players.find(p => p.id === conn.peer)) {
                            gameState.players.push({ id: conn.peer, name: data.payload.name, score: 20, isHost: false });
                            broadcastState();
                        }
                    } else if (data.type === 'ACTION') {
                        processGameAction(data.payload);
                    }
                };

                const processGameAction = (action) => {
                    if (action.type === 'SUBMIT_ACTIVE_CHOICE') {
                        if (gameState.phase !== 'answering') return;
                        gameState.activeChoice = action.value;
                        gameState.phase = 'betting';
                        broadcastState();
                    }
                    else if (action.type === 'SUBMIT_BET') {
                        gameState.bets[action.playerId] = { answer: action.value.answer, wager: action.value.wager };
                        // Check if all bets are in
                        const bettersCount = gameState.players.length - 1;
                        if (Object.keys(gameState.bets).length >= bettersCount) {
                            calculateScores();
                        } else {
                            broadcastState();
                        }
                    }
                };

                // --- GAME CONTROL ---
                const startGameLogic = () => {
                    gameState.round = 1;
                    gameState.usedQuestions = [];
                    pickRandomQuestion();
                    gameState.activePlayerId = gameState.players[0].id;
                    startRound();
                };

                const pickRandomQuestion = () => {
                    let available = RAW_QUESTIONS.map((_, idx) => idx).filter(idx => !gameState.usedQuestions.includes(idx));
                    if (available.length === 0) {
                        gameState.usedQuestions = []; // Reset if all used
                        available = RAW_QUESTIONS.map((_, idx) => idx);
                    }
                    const rand = available[Math.floor(Math.random() * available.length)];
                    gameState.questionIndex = rand;
                    gameState.usedQuestions.push(rand);
                }

                const startRound = () => {
                    gameState.phase = 'answering';
                    gameState.activeChoice = null;
                    gameState.bets = {};
                    broadcastState();
                    view.value = 'game'; // Force view update for Host
                };

                const calculateScores = () => {
                    gameState.phase = 'result';
                    gameState.players.forEach(p => {
                        const isAct = p.id === gameState.activePlayerId;
                        const bet = gameState.bets[p.id];
                        if (isAct) {
                            const correctGuesses = Object.values(gameState.bets).filter(b => b.answer === gameState.activeChoice).length;
                            p.score += (correctGuesses * 2);
                        } else if (bet) {
                            if (bet.answer === gameState.activeChoice) p.score += (bet.wager * 2); // Won wager + initial stake back logic roughly
                            else p.score -= bet.wager;
                        }
                    });
                    broadcastState();
                };

                const nextRound = () => {
                    if (gameState.round >= maxRounds) {
                        gameState.phase = 'gameover';
                        broadcastState();
                        view.value = 'gameover';
                        return;
                    }
                    gameState.round++;
                    // Rotate player
                    const currIdx = gameState.players.findIndex(p => p.id === gameState.activePlayerId);
                    const nextIdx = (currIdx + 1) % gameState.players.length;
                    gameState.activePlayerId = gameState.players[nextIdx].id;
                    
                    pickRandomQuestion();
                    startRound();
                };

                const restartGame = () => {
                    gameState.players.forEach(p => p.score = 20);
                    startGameLogic();
                };

                // --- PLAYER ACTIONS ---
                const submitActiveChoice = (idx) => {
                    // CRITICAL FIX: If I am Host AND Active, I must process locally
                    if (isHost.value) {
                        processGameAction({ type: 'SUBMIT_ACTIVE_CHOICE', playerId: myId.value, value: idx });
                    } else {
                        conn.value.send({ type: 'ACTION', payload: { type: 'SUBMIT_ACTIVE_CHOICE', playerId: myId.value, value: idx } });
                    }
                };

                const submitBet = () => {
                    hasBet.value = true;
                    const payload = {
                        type: 'SUBMIT_BET',
                        playerId: myId.value,
                        value: { answer: selectedBetAnswer.value, wager: betAmount.value }
                    };
                    if (isHost.value) processGameAction(payload);
                    else conn.value.send({ type: 'ACTION', payload });
                };

                const copyLink = () => {
                    navigator.clipboard.writeText(shareLink.value);
                    alert("Skopiowano link!");
                }

                // Reset local state
                watch(() => gameState.phase, (newVal) => {
                    if (newVal === 'answering') {
                        hasBet.value = false;
                        selectedBetAnswer.value = null;
                        betAmount.value = 1;
                    }
                });

                return {
                    view, nickname, urlGameId, errorMessage, shareLink, isHost,
                    gameState, players, myPlayer, activePlayerName, amIActive, currentQuestion,
                    createGame, joinGame, startGameLogic, nextRound, restartGame, copyLink,
                    submitActiveChoice, submitBet, selectedBetAnswer, betAmount, hasBet,
                    roundResults, sortedPlayers, maxRounds, getAvatar
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
